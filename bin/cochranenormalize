#!/usr/bin/env python
import argparse
import json
import os
import sys

sys.path.insert(0, os.path.dirname(sys.path[0]))

from lib import cochrane, pluck


if __name__ == '__main__':
	parser = argparse.ArgumentParser(
		description='Clean cochrane reviews')
	parser.add_argument('input', help='cochrane review jsonl file')
	args = parser.parse_args()
	results = {}
	repeated = set()
	for review in pluck.jsonl(args.input):
		try:
			id = cochrane.pubmed_id(review)
			normalized = cochrane.normalize(review)
		except ValueError as e:
			continue

		if id not in repeated:
			if id in results:
				del results[id]
				repeated.add(id)
			elif any(v != cochrane.NA for v in normalized.values()):
				output = {'id': id}
				output.update(normalized)
				results[id] = output
	for result in results.values():
		print json.dumps(result)
